<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>循環四子棋（輪替版） - FuLab</title>
  <link rel="stylesheet" href="fulab-theme.css">
  <style>
    .boardWrap { display: flex; justify-content: center; }
    .board {
      width: min(92vw, 440px);
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    .cell {
      aspect-ratio: 1 / 1;
      border: 1px solid var(--fulab-silver);
      border-radius: 12px;
      background: var(--fulab-bg-secondary);
      font-size: clamp(36px, 10vw, 52px);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 120ms ease, border-color 120ms ease;
      position: relative;
    }
    .cell:focus-visible {
      outline: 2px solid var(--fulab-tint-teal);
      outline-offset: 2px;
    }
    .cell.win { background: var(--fulab-tint-emerald); border-color: var(--fulab-emerald); }
    .cell.oldest-x { box-shadow: 0 0 0 2px var(--fulab-tint-indigo); }
    .cell.oldest-o { box-shadow: 0 0 0 2px var(--fulab-tint-amber); }
    .info { text-align:center; margin: 10px 0; font-weight: 650; }
    .pillRow { margin-bottom: 6px; }
  </style>
</head>
<body>
  <main>
    <section class="card">
      <h1>循環四子棋（輪替版）</h1>
      <p class="lead">4×4 棋盤。每位玩家場上最多 4 顆棋；放滿後，新落子會將自己最早落下的棋「搬到」新格子。先連成四子者獲勝。</p>
      <div class="boardWrap">
        <div id="board" class="board"></div>
      </div>
      <div class="info" id="statusText"></div>
      <div class="pillRow pillRow">
        <span class="pill">回合：<strong id="turnKpi">0</strong></span>
        <span class="pill">玩家：<strong id="playerKpi">X</strong></span>
      </div>
      <div class="btnRow">
        <button class="btn primary" id="newGame">新局</button>
        <button class="btn secondary" id="reset">重置</button>
      </div>
    </section>

    <section class="card">
      <h2 class="sectionTitle">規則</h2>
      <ul class="list">
        <li>最多 4 顆棋：前 4 回合直接落子；之後每次落子都會把自己最早落下的棋移到新位置（保持 4 顆）。</li>
        <li>不允許覆蓋對方棋；若移動目標被占，需換空格。</li>
        <li>任一方達成橫、直或對角 4 子連線即獲勝。</li>
      </ul>
    </section>
  </main>

  <script>
    const boardEl = document.getElementById('board');
    const statusEl = document.getElementById('statusText');
    const turnEl = document.getElementById('turnKpi');
    const playerEl = document.getElementById('playerKpi');
    const newBtn = document.getElementById('newGame');
    const resetBtn = document.getElementById('reset');

    const lines = [
      [0,1,2,3],[4,5,6,7],[8,9,10,11],[12,13,14,15],
      [0,4,8,12],[1,5,9,13],[2,6,10,14],[3,7,11,15],
      [0,5,10,15],[3,6,9,12]
    ];

    let board, placed, order, player, turn, over, winLine;

    function reset() {
      board = Array(16).fill('');
      placed = { X:0, O:0 };
      order = { X:[], O:[] };
      player = 'X';
      turn = 0;
      over = false;
      winLine = [];
      render();
    }

    function checkWin(p, b=board) {
      for (const ln of lines) {
        if (ln.every(i => b[i] === p)) return ln;
      }
      return null;
    }

    function applyMove(idx) {
      if (over) return;
      if (board[idx] !== '') return;

      if (placed[player] < 4) {
        board[idx] = player;
        placed[player]++;
        order[player].push(idx);
      } else {
        const from = order[player][0];
        board[from] = '';
        board[idx] = player;
        order[player].shift();
        order[player].push(idx);
      }

      turn++;
      const wl = checkWin(player);
      if (wl) {
        over = true;
        winLine = wl;
        render();
        return;
      }
      player = (player === 'X') ? 'O' : 'X';
      render();
    }

    function render() {
      boardEl.innerHTML = '';
      turnEl.textContent = String(turn);
      playerEl.textContent = player;

      const oldestX = order.X[0];
      const oldestO = order.O[0];

      board.forEach((v, i) => {
        const cell = document.createElement('button');
        cell.className = 'cell';
        cell.textContent = v;
        if (winLine.includes(i)) cell.classList.add('win');
        if (oldestX === i) cell.classList.add('oldest-x');
        if (oldestO === i) cell.classList.add('oldest-o');
        cell.disabled = over || v !== '';
        cell.addEventListener('click', () => applyMove(i));
        boardEl.appendChild(cell);
      });

      if (over) {
        statusEl.textContent = `${player} 連成四子，遊戲結束！`;
      } else {
        statusEl.textContent = `輪到 ${player}`;
      }
    }

    newBtn.addEventListener('click', reset);
    resetBtn.addEventListener('click', reset);
    reset();
  </script>
</body>
</html>
